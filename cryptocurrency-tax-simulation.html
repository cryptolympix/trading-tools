<!DOCTYPE html>
<html lang="fr">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Simulateur d'imposition cryptomonnaies</title>
    <style>
      body {
        font-family: Arial, sans-serif;
        background-color: #121212;
        color: #ffffff;
        margin: 0 auto;
        padding: 20px;
        width: 80%;
        display: flex;
        flex-direction: column;
        align-items: center;
      }
      h1,
      h2 {
        text-align: center;
        color: #ffffff;
      }
      form {
        width: 50%;
        min-width: 300px;
        display: flex;
        flex-direction: column;
        align-items: center;
      }
      label {
        width: 100%;
        display: block;
        margin-top: 10px;
      }
      input,
      select {
        padding: 10px;
        margin-top: 5px;
        background-color: #1e1e1e;
        color: #ffffff;
        border: 1px solid #333333;
        width: 100%;
        box-sizing: border-box;
      }
      button {
        padding: 10px 20px;
        margin-top: 15px;
        background-color: #007bff;
        color: white;
        border: none;
        cursor: pointer;
      }
      button:hover {
        background-color: #0056b3;
      }
      div {
        width: 100%;
        margin-top: 20px;
        padding: 15px;
        box-sizing: border-box;
      }
      #result {
        border: 1px solid #333333;
        background: #1e1e1e;
        text-align: left;
        width: auto;
      }
      table {
        width: 100%;
        border-collapse: collapse;
        margin-top: 20px;
        background-color: #1e1e1e;
        color: #ffffff;
      }
      th,
      td {
        border: 1px solid #333333;
        padding: 10px;
        text-align: center;
      }
      th {
        background-color: #333333;
      }
    </style>
  </head>
  <body>
    <h1>Simulateur d'imposition des cryptomonnaies</h1>
    <form id="taxSimulator">
      <label for="total_investment">Investissement initial (€) :</label>
      <input
        type="number"
        id="total_investment"
        placeholder="Entrez votre investissement initial"
        required
      />

      <label for="total_portfolio">Valeur du portefeuille (€) :</label>
      <input
        type="number"
        id="total_portfolio"
        placeholder="Entrez votre valeur totale de portefeuille"
        required
      />

      <label for="gain">Plus-value réalisée (€) :</label>
      <input type="number" id="gain" placeholder="Entrez votre gain" required />

      <label for="flatTax">Prélèvement Forfaitaire Unique (%) :</label>
      <input type="number" id="flatTax" value="30" required />

      <label for="socialTax">Taux des prélèvements sociaux (%) :</label>
      <input type="number" id="socialTax" value="17.2" required />

      <button type="button" onclick="displayResult()">Calculer</button>
    </form>

    <div id="result">
      Remplissez les informations ci-dessus et cliquez sur "Calculer".
    </div>

    <div>
      <h2>Grille des taux d'imposition sur le revenu</h2>
      <table id="taxTable">
        <thead>
          <tr>
            <th>Tranche de revenu (€)</th>
            <th>Taux d'imposition (%)</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>
    </div>

    <script>
      const TAX_RATES_IR = [
        { min: 0, max: 11294, rate: 0 },
        { min: 11294, max: 28797, rate: 0.11 },
        { min: 28797, max: 82341, rate: 0.3 },
        { min: 82342, max: 177106, rate: 0.41 },
        { min: 177106, max: Infinity, rate: 0.45 },
      ];

      // https://www.economie.gouv.fr/particuliers/decote-impot-revenu
      const DECOTE_APPLICATION_THRESHOLD = [1929, 3191]; // The threshold for applying decote for 1 and 2 parts
      const DECOTE_MAX = [873, 1444]; // The max decote amount for 1 and 2 parts
      const DECOTE_PERCENTAGE = 0.4525; // The percentage of the decote

      // Populate the income tax table
      function populateTaxTable() {
        const tableBody = document.querySelector("#taxTable tbody");
        tableBody.innerHTML = ""; // Clear the table first
        TAX_RATES_IR.forEach((grid) => {
          const row = document.createElement("tr");
          const range =
            grid.max === Infinity
              ? `${grid.min} et plus`
              : `${grid.min} - ${grid.max}`;
          row.innerHTML = `
            <td>${range}</td>
            <td>${grid.rate * 100} %</td>
          `;
          tableBody.appendChild(row);
        });
      }

      function calculateIR(gain) {
        let tax = 0;
        for (const bracket of TAX_RATES_IR) {
          if (gain > bracket.min) {
            const taxableAmount = Math.min(
              bracket.max - bracket.min,
              gain - bracket.min
            );
            tax += taxableAmount * bracket.rate;
          }
        }
        return tax;
      }

      function calculateFlatTax(
        totalInvestment,
        totalPortfolio,
        gain,
        flatTaxRate
      ) {
        // Calcul Flat Tax
        return (gain - totalInvestment * (gain / totalPortfolio)) * flatTaxRate;
      }

      function calculateDecote(tax, familyQuotient = 1) {
        const decoteThreshold =
          familyQuotient == 1
            ? DECOTE_APPLICATION_THRESHOLD[0]
            : DECOTE_APPLICATION_THRESHOLD[1];

        const decoteMax = familyQuotient == 1 ? DECOTE_MAX[0] : DECOTE_MAX[1];

        if (tax <= decoteThreshold) {
          let decote = decoteMax - tax * DECOTE_PERCENTAGE;
          if (tax - decote > 0) {
            return decoteMax - tax * DECOTE_PERCENTAGE;
          } else {
            return tax;
          }
        }
        return 0;
      }

      function displayResult() {
        // Récupération des données
        const totalInvestment = parseFloat(
          document.getElementById("total_investment").value
        );
        const totalPortfolio = parseFloat(
          document.getElementById("total_portfolio").value
        );
        const gain = parseFloat(document.getElementById("gain").value);
        const flatTaxRate = parseFloat(
          document.getElementById("flatTax").value
        );
        const socialTaxRate = parseFloat(
          document.getElementById("socialTax").value
        );

        if (
          isNaN(totalInvestment) ||
          isNaN(totalPortfolio) ||
          isNaN(gain) ||
          isNaN(flatTaxRate) ||
          isNaN(socialTaxRate)
        ) {
          document.getElementById("result").innerHTML =
            "Veuillez entrer une plus-value valide.";
          return;
        }

        // Calcul Flat Tax
        const flatTax = calculateFlatTax(
          totalInvestment,
          totalPortfolio,
          gain,
          flatTaxRate / 100
        );
        const flatTaxPercentage = (flatTax / gain) * 100;

        // Calcul Barème Progressif
        const incomeTax = calculateIR(gain);
        const decote = calculateDecote(incomeTax);
        const incomeTaxWithDecote = incomeTax - decote;
        const socialTax = (socialTaxRate / 100) * gain;
        const totalProgressiveTax = incomeTaxWithDecote + socialTax;
        const progressiveTaxPercentage = (totalProgressiveTax / gain) * 100;

        // Affichage des résultats
        document.getElementById("result").innerHTML = `
        <h2>Résultats :</h2>
        <p><strong>Plus-value :</strong> ${gain.toFixed(0)} €</p>
        <p><strong>Imposition via Flat Tax :</strong> ${flatTax.toFixed(
          0
        )} € (${flatTaxPercentage.toFixed(2)}%)</p>
        <p><strong>Imposition via Barème Progressif :</strong></p>
        <ul>
          <li>Impôt sur le revenu : ${incomeTax.toFixed(0)} €</li>
          <li>Décote : ${decote.toFixed(0)} €</li>
          <li>Prélèvements sociaux (${socialTaxRate}%) : ${socialTax.toFixed(
          0
        )} €</li>
          <li><strong>Total :</strong> ${totalProgressiveTax.toFixed(
            0
          )} € (${progressiveTaxPercentage.toFixed(2)}%)</li>
        </ul>
        <p><strong>Conclusion :</strong> ${
          flatTax < totalProgressiveTax
            ? "La Flat Tax est plus avantageuse."
            : "Le Barème Progressif est plus avantageux."
        }</p>
      `;
      }

      // Initialize the tax table on page load
      window.onload = populateTaxTable;
    </script>
  </body>
</html>
